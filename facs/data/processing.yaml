manual_mining:
  - description: 'look for known suspicious filenames on disk (LOL, old privesc tricks, attacker toolbox, ...)'
    note: 'see wordlist_windows_disk.txt'
  - description: 'look for known suspicious executions in the time frame'
    note: 'see wordlist_windows_execution.txt'
  - description: 'look for unusual binary types in user profile'
    note: 'ps1|bat|vba|vbs|dll|exe|msi'
  - description: 'databases to check hashes against'
    note: 'virustotal, nsrl, any.run, hybrid-analysis, tria.ge, labs.inquest.net'
  - description: 'look for credentials in GPO'
    note: 'browse sysvol on DC'
  - description: 'look for specific logs (RAT, AV, Cloud ...)'
    note: 'py_facs logs windows'

patterns:
  - tool: 'mimikatz'
    detection:
      - 'built into several toolbox, like cobalt strike''s beacon, empire, lazagne, and meterpreter'
      - '.kirbi files when dumping kerberos tickets'
      - 'security EID 4703: token rights elevated, SeDebugPrivilege'
      - 'security EID 4656: handle to object requested, process = powershell, object name = lsass.exe, access mask = 0x143A (standalone) or 0x1410 (from empire)'
      - 'security EID 4663: object access, process = powershell, access mask = 0x10, object name = lsass.exe'
      - 'security EID 4624+4634+4672 at the same timestamp when performing lsadump'
      - 'sysmon EID 1+10: 1 (parent image= cmd.exe), 10 (srcImage != svchost.exe and targetImage=lsass.exe and grantAcess=0x1010)'
      - 'sysmon EID 11: file created, image=mimikatz'

  - tool: 'psexec'
    detection:
      - 'security EID 4624+4634 in the same minute (using impacket)'
      - 'psexesvc.exe or random exe name in systemroot path of the target (depends if framework used)'
      - 'security EID 7045: service installed, psexesvc, or random exe if framework used'
      - 'psexesvc or random exe name spawns rundll32.exe them multiple cmd.exe (meterpreter to install reverse shell)'
      - 'EulaAccepted registry key in SOFTWARE hive for SysInternals'
      - 'sysmon EID 3: network connection, image=psexec on the source (using mimikatz)'
      - 'sysmon EID 22: DNS query, image=psexec on the source (using mimikatz)'
      - 'security EID 4697'

  - tool: 'smbexec'
    detection:
      - 'security EID 7045: service name BTOBTO (using impacket) with a bat file executed'

  - tool: 'wmiexec'
    detection:
      - 'svchost.exe spawns a chain of process wmiprvse.exe > cmd.exe > conhost.exe'

  - tool: 'dcomexec'
    detection:
      - 'security EID 4624+4634 in the same minute (using impacket)'
      - 'mmc.exe spawns cmd.exe'

  - tool: 'powershell'
    detection:
      - 'dedicated EIDs, 4103/4104/600 might capture part of scripts'
      - 'downgrade to Powershell v2 to avoid script block logging'
      - 'ideas in https://github.com/SigmaHQ/sigma/tree/master/rules/windows/powershell'

  - tool: 'bloodhound'
    detection:
      - 'high volume of LDAP traffic to the AD (port 389) from a same source'
      - 'security EID 4662 on honey accounts/groups to detect enumeration'

  - tool: 'cobalt strike'
    detection:
      - 'lateral movement: psexec, smbexec, wmiexec, winrm'
      - 'see https://www.sekoia.io/en/hunting-and-detecting-cobalt-strike/'
      - 'see powerhsell artifacts'
      - 'DNS beaconing: DNS queries contains cdn for A request + api for for TXT request + www6 for AAAA request'
      - 'DNS/HTTP beaconing: if configured by default, around 200 req per minute'
      - 'runddl32.exe spawned without command argument and established a connection'

  - tool: 'empire'
    detection:
      - 'lateral movement: psexec, dcomexec, smbexec'
      - 'see powershell artifacts'

  - tool: 'metasploit/powersploit'
    detection:
      - 'lateral movement: psexec, winrm, wmiexec'
      - 'sysmon EID 3: network connection, image=powershell during recon'
      - 'sysmon EID 22: DNS query, image=powershell during recon'
      - 'runddl32.exe spawned as a child of legit exe (eg. notepad)'
      - 'scheduled task creation by the user for persistent reverse shell'
      - 'sysmon EID 11: file created, image=powershell, target= random ps1 in AppData of the user'
      - 'powershell spawns schtasks.exe and csc.exe'
      - 'reverse connection established by rundll32.exe'

  - tool: 'impacket'
    detection:
      - 'security EID 4624+4634+4672 at the same timestamp when dumping secrets'
      - 'kerberoasting: connections to DC port 88 (KDC) with process != lsass.exe'
      - 'system EID 7040: remote registry started'

  - tool: 'rubeus'
    detection:
      - 'kerberoasting: connections to DC port 88 (KDC) with process != lsass.exe'
      - 'files created .kirbi, .asreproast, .kerberoast'
      - 'similar to mimikatz'

  - tool: 'lolbins'
    detection:
      - 'most common observed from https://blog.talosintelligence.com/2019/11/hunting-for-lolbins.html'
      - 'other from https://infosecwriteups.com/common-tools-techniques-used-by-threat-actors-and-malware-part-i-deb05b664879'
      - 'included in execution wordlist'


defaults:
  - description: 'default RDP port'
    value: '3389'
  - description: 'default Anydesk port'
    value: '6568'
  - description: 'default TeamViewer port'
    value: '5938'
  - description: 'default VNC port'
    value: '5800/5900'
  - description: 'default port of meterpreter reverse shell'
    value: '4444'
  - description: 'empire default stager name'
    value: 'launcher.bat, launcher.vbs'
  - description: 'empire default behavior of C2 beacons'
    value: 'GET /login/process.php + GET /admin/get.php + GET /news.php'

win_profiling:
  - description: 'collect start/end of event logs for main channels'
  - description: 'look for defence evasion: system backdated'
  - description: 'look for defence evasion: event logs cleared/stopped'
  - description: 'verify the host was active for the time frame: boot/shutdown'
  - description: 'verify the host is the correct one: hostname, last IP, local users'
  - description: 'profile the local users: login history, group membership, SID'
  - description: 'profile the system: network history'
  - description: 'profile the system: USB history'
  - description: 'profile the system: installed/uninstalled software'
  - description: 'profile the system: startup process and services'
  - description: 'profile the system: analyze the srum (System Resource Usage Monitor)'
